(()=>{"use strict";const e={apiUrl:"http://localhost:27123",apiKey:"",vaultName:"",folderPath:"Clippings",enabled:!0,webhookUrl:"",useWebhook:!1,defaultTags:["clippings"],defaultAuthor:"",includeDescription:!0,includePublishDate:!0};var t;function a(e){return[/youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,/youtu\.be\/([a-zA-Z0-9_-]{11})/,/youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,/youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/].some(t=>t.test(e))}!function(e){e.CLIP_PAGE="CLIP_PAGE",e.CHECK_DUPLICATE="CHECK_DUPLICATE",e.GET_SETTINGS="GET_SETTINGS",e.SAVE_SETTINGS="SAVE_SETTINGS",e.BATCH_CLIP_TABS="BATCH_CLIP_TABS",e.BATCH_PROGRESS="BATCH_PROGRESS"}(t||(t={}));class s{constructor(e){this.tabId=e}async start(e){await this.showProgress(e,0)}async update(e){await this.showProgress(e.message,e.progress)}async complete(e="Completed!"){await chrome.action.setBadgeText({tabId:this.tabId,text:"âœ“"}),await chrome.action.setBadgeBackgroundColor({tabId:this.tabId,color:"#22c55e"}),this.notificationId=await this.createNotification({type:"basic",iconUrl:"icons/icon128.png",title:"Clipped Successfully",message:e,silent:!0}),setTimeout(async()=>{await chrome.action.setBadgeText({tabId:this.tabId,text:""}),this.notificationId&&await chrome.notifications.clear(this.notificationId)},2e3)}async error(e,t){await chrome.action.setBadgeText({tabId:this.tabId,text:"âœ—"}),await chrome.action.setBadgeBackgroundColor({tabId:this.tabId,color:"#ef4444"}),this.notificationId=await this.createNotification({type:"basic",iconUrl:"icons/icon128.png",title:"Clipping Failed",message:t?`${e}: ${t.message}`:e,requireInteraction:!0}),setTimeout(async()=>{await chrome.action.setBadgeText({tabId:this.tabId,text:""})},3e3)}async showProgress(e,t){const a=Math.round(100*t);await chrome.action.setBadgeText({tabId:this.tabId,text:`${a}%`}),await chrome.action.setBadgeBackgroundColor({tabId:this.tabId,color:"#f97316"}),this.notificationId?await chrome.notifications.update(this.notificationId,{message:e,progress:a}):this.notificationId=await this.createNotification({type:"progress",iconUrl:"icons/icon128.png",title:"Clipping...",message:e,progress:a,silent:!0})}async createNotification(e){return new Promise(t=>{chrome.notifications.create(e,e=>{t(e)})})}}const o={message:"Extracting page content...",progress:.1},r={message:"Getting video transcript...",progress:.3},i={message:"Processing content...",progress:.5},n={message:"Saving to Obsidian...",progress:.9},c=new class{constructor(){this.dbName="QuickObsidianClipper",this.storeName="clips",this.db=null}async initialize(){return new Promise((e,t)=>{const a=indexedDB.open(this.dbName,1);a.onerror=()=>t(a.error),a.onsuccess=()=>{this.db=a.result,e()},a.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(this.storeName)){const e=t.createObjectStore(this.storeName,{keyPath:"id"});e.createIndex("status","status",{unique:!1}),e.createIndex("addedAt","addedAt",{unique:!1})}}})}async add(e){await this.ensureInitialized();const t={id:this.generateId(),clipData:e,status:"pending",attempts:0,addedAt:Date.now()};return new Promise((e,a)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).add(t);s.onsuccess=()=>e(t.id),s.onerror=()=>a(s.error)})}async getPending(){return await this.ensureInitialized(),new Promise((e,t)=>{const a=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).index("status").getAll("pending");a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error)})}async updateStatus(e,t,a){return await this.ensureInitialized(),new Promise((s,o)=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),i=r.get(e);i.onsuccess=()=>{const e=i.result;e.status=t,e.lastAttempt=Date.now(),a&&(e.error=a),"processing"===t&&e.attempts++;const n=r.put(e);n.onsuccess=()=>s(),n.onerror=()=>o(n.error)},i.onerror=()=>o(i.error)})}async remove(e){return await this.ensureInitialized(),new Promise((t,a)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(e);s.onsuccess=()=>t(),s.onerror=()=>a(s.error)})}async getStats(){return await this.ensureInitialized(),new Promise((e,t)=>{const a=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();a.onsuccess=()=>{const t=a.result;e({pending:t.filter(e=>"pending"===e.status).length,completed:t.filter(e=>"completed"===e.status).length,failed:t.filter(e=>"failed"===e.status).length})},a.onerror=()=>t(a.error)})}async cleanupOld(e=2592e6){await this.ensureInitialized();const t=Date.now()-e,a=(await this.getAll()).filter(e=>"completed"===e.status&&e.addedAt<t);for(const e of a)await this.remove(e.id);return a.length}async getAll(){return new Promise((e,t)=>{const a=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error)})}async ensureInitialized(){this.db||await this.initialize()}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},l=new class{constructor(){this.maxAttempts=5,this.baseDelay=1e3,this.maxDelay=6e4}shouldRetry(e){return e<this.maxAttempts}getDelay(e){const t=this.baseDelay*Math.pow(2,e);return Math.min(t,this.maxDelay)}async retry(e,t=0){try{return await e()}catch(a){if(!this.shouldRetry(t))throw a;const s=this.getDelay(t);return await this.sleep(s),this.retry(e,t+1)}}sleep(e){return new Promise(t=>setTimeout(t,e))}},h=new class{constructor(){this.urlCache=new Map,this.hashCache=new Map}async isDuplicate(e,t){const a=this.normalizeUrl(e.url);if(this.urlCache.has(a))return{isDuplicate:!0,matchType:"url",reason:"URL already clipped"};if(await t(a))return this.urlCache.set(a,!0),{isDuplicate:!0,matchType:"url",reason:"URL found in vault"};const s=await this.checkPlatformId(e,t);if(s.isDuplicate)return s;const o=await this.hashContent(e.content);return this.hashCache.has(o)?{isDuplicate:!0,matchType:"content"}:(this.urlCache.set(a,!1),this.hashCache.set(o,!1),{isDuplicate:!1})}normalizeUrl(e){try{const t=new URL(e);if(this.isYouTube(e))return`https://youtube.com/watch?v=${this.extractYouTubeId(e)}`;if(this.isTwitter(e))return`https://twitter.com/status/${this.extractTweetId(e)}`;["utm_source","utm_medium","utm_campaign","utm_term","utm_content","fbclid","gclid","ref","source","_hsenc","_hsmi"].forEach(e=>{t.searchParams.delete(e)}),t.hash="",t.pathname.startsWith("/amp/")&&(t.pathname=t.pathname.replace("/amp/","/")),t.hostname=t.hostname.replace(/^www\./,"");const a=[];t.searchParams.forEach((e,t)=>{a.push([t,e])}),a.sort();const s=new URLSearchParams(a);return t.search=s.toString(),t.toString().toLowerCase()}catch(t){return console.error("URL normalization failed:",t),e.toLowerCase()}}async checkPlatformId(e,t){if(this.isYouTube(e.url)){const a=this.extractYouTubeId(e.url);if(a&&await t(a))return{isDuplicate:!0,matchType:"video_id"}}if(this.isTwitter(e.url)){const a=this.extractTweetId(e.url);if(a&&await t(a))return{isDuplicate:!0,matchType:"tweet_id"}}return{isDuplicate:!1}}async hashContent(e){const t=e.toLowerCase().replace(/\s+/g," ").trim().substring(0,1e4);let a=0;for(let e=0;e<t.length;e++)a=(a<<5)-a+t.charCodeAt(e),a&=a;return a.toString(36)}isYouTube(e){return e.includes("youtube.com")||e.includes("youtu.be")}isTwitter(e){return e.includes("twitter.com")||e.includes("x.com")}extractYouTubeId(e){const t=[/youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,/youtu\.be\/([a-zA-Z0-9_-]{11})/,/youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,/youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/];for(const a of t){const t=e.match(a);if(t&&t[1])return t[1]}return null}extractTweetId(e){const t=[/twitter\.com\/\w+\/status\/(\d+)/,/x\.com\/\w+\/status\/(\d+)/];for(const a of t){const t=e.match(a);if(t&&t[1])return t[1]}return null}clearCache(){this.urlCache.clear(),this.hashCache.clear()}},u=new class{constructor(){this.healthCache=new Map,this.cacheDuration=3e4}async checkWebhook(e){const t=this.healthCache.get(e);if(t&&Date.now()-t.lastCheck<this.cacheDuration)return t.webhookAvailable;try{const t=new AbortController,a=setTimeout(()=>t.abort(),2e3),s=await fetch(`${e.replace("/webhook","")}/health`,{signal:t.signal});clearTimeout(a);const o=s.ok;return this.healthCache.set(e,{isHealthy:o,webhookAvailable:o,apiAvailable:!0,lastCheck:Date.now()}),o}catch(t){return this.healthCache.set(e,{isHealthy:!1,webhookAvailable:!1,apiAvailable:!0,lastCheck:Date.now(),error:t instanceof Error?t.message:"Unknown error"}),!1}}async checkAPI(e,t){const a=`api:${e}`,s=this.healthCache.get(a);if(s&&Date.now()-s.lastCheck<this.cacheDuration)return s.apiAvailable;try{const s=new AbortController,o=setTimeout(()=>s.abort(),2e3),r=await fetch(`${e}/`,{headers:{Authorization:`Bearer ${t}`},signal:s.signal});clearTimeout(o);const i=r.ok||404===r.status;return this.healthCache.set(a,{isHealthy:i,webhookAvailable:!1,apiAvailable:i,lastCheck:Date.now()}),i}catch(e){return this.healthCache.set(a,{isHealthy:!1,webhookAvailable:!1,apiAvailable:!1,lastCheck:Date.now(),error:e instanceof Error?e.message:"Unknown error"}),!1}}async getHealthStatus(e){const[t,a]=await Promise.all([e.useWebhook&&e.webhookUrl?this.checkWebhook(e.webhookUrl):Promise.resolve(!1),this.checkAPI(e.apiUrl,e.apiKey)]);return{isHealthy:t||a,webhookAvailable:t,apiAvailable:a,lastCheck:Date.now()}}async autoRepair(e){const t=await this.getHealthStatus(e);return!t.webhookAvailable&&t.apiAvailable?{fixed:!1,message:"Webhook unavailable. Falling back to direct API mode."}:t.apiAvailable?{fixed:!0,message:"All systems operational"}:{fixed:!1,message:"Cannot reach Obsidian Local REST API. Please check if Obsidian is running and the plugin is enabled."}}clearCache(){this.healthCache.clear()}},d=new class{constructor(){this.jobs=new Map,this.concurrency=3}async clipAllTabs(){const e=(await chrome.tabs.query({currentWindow:!0})).map(e=>e.url).filter(e=>!!e&&this.isClippable(e));return this.createBatchJob(e)}async clipTabs(e){const t=(await Promise.all(e.map(e=>chrome.tabs.get(e)))).map(e=>e.url).filter(e=>!!e&&this.isClippable(e));return this.createBatchJob(t)}async clipUrls(e){const t=e.filter(e=>this.isClippable(e));return this.createBatchJob(t)}async clipPlaylist(e){throw new Error("YouTube playlist clipping requires API configuration")}getJob(e){return this.jobs.get(e)}cancelJob(e){const t=this.jobs.get(e);t&&"processing"===t.status&&(t.status="failed",t.completedAt=Date.now())}createBatchJob(e){const t={id:this.generateJobId(),urls:e,status:"pending",completed:0,failed:0,total:e.length,startedAt:Date.now()};return this.jobs.set(t.id,t),this.processBatch(t.id).catch(e=>{console.error("Batch processing failed:",e),t.status="failed",t.completedAt=Date.now()}),t}async processBatch(e){const t=this.jobs.get(e);if(t){t.status="processing";for(let a=0;a<t.urls.length;a+=this.concurrency){const s=t.urls.slice(a,a+this.concurrency);(await Promise.allSettled(s.map(e=>this.clipUrl(e)))).forEach((e,a)=>{"fulfilled"===e.status?t.completed++:(t.failed++,console.error(`Failed to clip ${s[a]}:`,e.reason))}),this.jobs.set(e,t),chrome.runtime.sendMessage({type:"BATCH_PROGRESS",data:{jobId:e,progress:(t.completed+t.failed)/t.total,completed:t.completed,failed:t.failed}}),a+this.concurrency<t.urls.length&&await this.sleep(1e3)}t.status="completed",t.completedAt=Date.now(),this.jobs.set(e,t)}}async clipUrl(e){return new Promise((t,a)=>{chrome.tabs.create({url:e,active:!1},async e=>{if(e.id)try{await this.waitForPageLoad(e.id),await chrome.tabs.sendMessage(e.id,{action:"clip"}),await chrome.tabs.remove(e.id),t()}catch(e){a(e)}else a(new Error("Failed to create tab"))})})}async waitForPageLoad(e){return new Promise(t=>{const a=(s,o)=>{s===e&&"complete"===o.status&&(chrome.tabs.onUpdated.removeListener(a),t())};chrome.tabs.onUpdated.addListener(a),setTimeout(()=>{chrome.tabs.onUpdated.removeListener(a),t()},3e4)})}isClippable(e){return e.startsWith("http://")||e.startsWith("https://")}sleep(e){return new Promise(t=>setTimeout(t,e))}generateJobId(){return`batch-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},p=new Set;async function m(e,t,a){const s=await c.add(e);await a.complete("Queued for later - will retry when online"),console.log(`Clip queued: ${s}`)}async function g(){const t=await c.getPending();if(0===t.length)return;console.log(`Processing ${t.length} queued clips`);const{settings:s}=await chrome.storage.local.get("settings"),o=s||e;for(const e of t)try{await c.updateStatus(e.id,"processing"),(a(e.clipData.url)?await y(e.clipData,o):await f(e.clipData,o))?(await c.updateStatus(e.id,"completed"),p.add(e.clipData.url),await chrome.storage.local.set({clippedUrls:Array.from(p)})):await c.updateStatus(e.id,"failed","Clipping failed")}catch(t){console.error(`Failed to process queued clip ${e.id}:`,t),await c.updateStatus(e.id,"failed",t instanceof Error?t.message:"Unknown error")}await c.cleanupOld(6048e5)}async function w(e,t,a,s){e?(p.add(a.url),await chrome.storage.local.set({clippedUrls:Array.from(p)}),await s.complete(`Saved: ${a.title}`)):await s.error("Failed to save clip")}async function b(e,t){const a=h.normalizeUrl(t);Array.from(p).some(e=>h.normalizeUrl(e)===a)?(await chrome.action.setBadgeText({tabId:e,text:"âœ“"}),await chrome.action.setBadgeBackgroundColor({tabId:e,color:"#22c55e"})):await chrome.action.setBadgeText({tabId:e,text:""})}async function f(e,t){if(console.log("ðŸ”µ clipToObsidian called with:",{title:e.title,url:e.url}),!t.apiKey)throw console.error("âŒ API key not configured"),new Error("API key not configured. Please set it in the options page.");if(!t.vaultName)throw console.error("âŒ Vault name not configured"),new Error("Vault name not configured. Please set it in the options page.");const a=I(e,t);console.log("ðŸ“ Generated note content, length:",a.length);const s=T(e.title),o=t.folderPath?`${t.folderPath}/${s}.md`:`${s}.md`,r=`${t.apiUrl.replace(/\/$/,"")}/vault/${o}`;console.log("ðŸŒ API URL:",r),console.log("ðŸ“ Filepath:",o);try{return await l.retry(async()=>{console.log("ðŸ”„ Attempting API request...");const e=await fetch(r,{method:"PUT",headers:{Authorization:`Bearer ${t.apiKey}`,"Content-Type":"text/markdown"},body:a});if(console.log("ðŸ“¡ Response status:",e.status,e.statusText),!e.ok){const t=await e.text();throw console.error("âŒ API request failed:",e.status,t),new Error(`API request failed: ${e.status} ${t}`)}const s=await e.text();return console.log("âœ… API request successful:",s),!0}),console.log("âœ… Note created successfully"),!0}catch(e){throw console.error("âŒ Failed to create note after retries:",e),e}}async function y(e,t){if(console.log("ðŸ”µ clipYouTubeVideo called with:",{title:e.title,url:e.url}),!t.apiKey)throw console.error("âŒ API key not configured"),new Error("API key not configured. Please set it in the options page.");if(!t.vaultName)throw console.error("âŒ Vault name not configured"),new Error("Vault name not configured. Please set it in the options page.");const a=I(e,t);console.log("ðŸ“ Generated YouTube note content, length:",a.length);const s=T(e.title),o=t.folderPath?`${t.folderPath}/${s}.md`:`${s}.md`,r=`${t.apiUrl.replace(/\/$/,"")}/vault/${o}`;console.log("ðŸŒ API URL:",r),console.log("ðŸ“ Filepath:",o);try{return await l.retry(async()=>{console.log("ðŸ”„ Attempting API request...");const e=await fetch(r,{method:"PUT",headers:{Authorization:`Bearer ${t.apiKey}`,"Content-Type":"text/markdown"},body:a});if(console.log("ðŸ“¡ Response status:",e.status,e.statusText),!e.ok){const t=await e.text();throw console.error("âŒ API request failed:",e.status,t),new Error(`API request failed: ${e.status} ${t}`)}const s=await e.text();return console.log("âœ… API request successful:",s),!0}),console.log("âœ… Successfully saved YouTube video clip"),!0}catch(e){throw console.error("âŒ Failed to create note after retries:",e),e}}async function A(e,t){try{const a=await fetch(`${t.apiUrl}/search/simple/?query=${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${t.apiKey}`}});return!!a.ok&&(await a.json()).length>0}catch(e){return console.warn("Vault search failed:",e),!1}}function I(e,t){const a=["---"];a.push(`title: "${e.title.replace(/"/g,'\\"')}"`),a.push(`source: "${e.url}"`),e.author&&e.author.length>0?(a.push("author:"),e.author.forEach(e=>{a.push(`  - "[[${e}]]"`)})):t.defaultAuthor&&(a.push("author:"),a.push(`  - "[[${t.defaultAuthor}]]"`)),t.includePublishDate&&e.published&&a.push(`published: ${e.published}`);const s=new Date(e.timestamp).toISOString().split("T")[0];return a.push(`created: ${s}`),t.includeDescription&&e.description&&a.push(`description: "${e.description.replace(/"/g,'\\"')}"`),a.push("tags:"),(t.defaultTags||["clippings"]).forEach(e=>{a.push(`  - "${e}"`)}),a.push("---",""),a.push(e.content),a.join("\n")}function T(e){return`${(new Date).toISOString().split("T")[0]} âŒ‡ ${e.replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g," ").trim().substring(0,100)}`}chrome.runtime.onInstalled.addListener(async()=>{console.log("Quick Obsidian Clipper installed"),(await chrome.storage.local.get("settings")).settings||await chrome.storage.local.set({settings:e});const t=await chrome.storage.local.get("clippedUrls");t.clippedUrls&&t.clippedUrls.forEach(e=>p.add(e)),await g()}),chrome.action.onClicked.addListener(async t=>{if(console.log("ðŸ–±ï¸ Extension icon clicked for tab:",t.url),!t.id||!t.url)return void console.error("âŒ Invalid tab - no ID or URL");const c=new s(t.id);try{console.log("â–¶ï¸ Starting clip process..."),await c.start("Starting clip...");const s=new Promise((e,t)=>{const a=setTimeout(()=>{t(new Error("Content extraction timeout"))},2e4),s=t=>{console.log("ðŸ“¨ Received message:",t.type),"CONTENT_EXTRACTED"===t.type&&(console.log("âœ… Got CONTENT_EXTRACTED message!"),clearTimeout(a),chrome.runtime.onMessage.removeListener(s),e(t.data))};chrome.runtime.onMessage.addListener(s),console.log("ðŸ‘‚ Message listener set up")});console.log("ðŸ’‰ Injecting content script..."),await chrome.scripting.executeScript({target:{tabId:t.id},files:["content.js"]}),console.log("âœ… Content script injected, waiting for extracted data...");const d=await s;console.log("ðŸ“„ Extracted clip data:",{title:d.title,url:d.url,contentLength:d.content?.length}),await c.update(o),console.log("âš™ï¸ Loading settings...");const{settings:p}=await chrome.storage.local.get("settings"),g=p||e;console.log("âš™ï¸ Settings loaded:",{apiUrl:g.apiUrl,vaultName:g.vaultName,folderPath:g.folderPath,useWebhook:g.useWebhook}),await c.update({message:"Checking for duplicates...",progress:.2});const b=await h.isDuplicate(d,async e=>await A(e,g));b.isDuplicate&&(console.log(`âš ï¸ Re-clipping URL that was already saved: ${b.reason}`),await c.update({message:"Re-clipping (already exists)...",progress:.3}));const I=await u.getHealthStatus(g);if(g.useWebhook&&g.webhookUrl)if(I.webhookAvailable){await c.update(i);const e=await async function(e,t){if(!await u.checkWebhook(t))throw new Error("Webhook server is not responding");try{return await l.retry(async()=>{const a=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e.url,title:e.title,content:e.content,selectedText:e.selectedText,timestamp:e.timestamp})});if(!a.ok)throw new Error(`Webhook request failed: ${a.status}`);return!0}),!0}catch(e){throw console.error("Failed to send to webhook:",e),e}}(d,g.webhookUrl);await w(e,t.id,d,c)}else if(I.apiAvailable){console.warn("Webhook unavailable, falling back to direct API"),await c.update(n);const e=await f(d,g);await w(e,t.id,d,c)}else await m(d,t.id,c);else if(a(d.url)){await c.update(r);const e=await y(d,g);await w(e,t.id,d,c)}else{await c.update(n);const e=await f(d,g);await w(e,t.id,d,c)}}catch(e){if(await c.error("Clipping failed",e instanceof Error?e:void 0),e instanceof Error&&e.message.includes("fetch")){const[e]=await chrome.scripting.executeScript({target:{tabId:t.id},files:["content.js"]});e?.result&&await m(e.result,t.id,c)}}}),chrome.tabs.onActivated.addListener(async e=>{const t=await chrome.tabs.get(e.tabId);t.url&&await b(t.id,t.url)}),chrome.tabs.onUpdated.addListener((e,t,a)=>{t.url&&a.active&&b(e,t.url)}),chrome.runtime.onMessage.addListener((a,s,o)=>(async function(a){try{switch(a.type){case t.GET_SETTINGS:{const{settings:t}=await chrome.storage.local.get("settings");return{success:!0,data:t||e}}case t.SAVE_SETTINGS:return await chrome.storage.local.set({settings:a.data}),u.clearCache(),{success:!0};case t.CHECK_DUPLICATE:{const{settings:t}=await chrome.storage.local.get("settings"),s=t||e;return{success:!0,data:await h.isDuplicate(a.data,async e=>await A(e,s))}}case"BATCH_CLIP_TABS":return{success:!0,data:await d.clipAllTabs()};case"BATCH_PROGRESS":return chrome.runtime.sendMessage(a),{success:!0};default:return{success:!1,error:"Unknown message type"}}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}(a).then(o),!0)),chrome.alarms.create("process-queue",{periodInMinutes:5}),chrome.alarms.onAlarm.addListener(e=>{"process-queue"===e.name&&g().catch(e=>{console.error("Queue processing failed:",e)})}),chrome.alarms.create("keep-alive",{periodInMinutes:1}),chrome.alarms.onAlarm.addListener(e=>{"keep-alive"===e.name&&console.log("Service worker keep-alive ping")})})();