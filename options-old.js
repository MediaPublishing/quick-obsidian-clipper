(()=>{"use strict";var e;!function(e){e.CLIP_PAGE="CLIP_PAGE",e.CHECK_DUPLICATE="CHECK_DUPLICATE",e.GET_SETTINGS="GET_SETTINGS",e.SAVE_SETTINGS="SAVE_SETTINGS",e.BATCH_CLIP_TABS="BATCH_CLIP_TABS",e.BATCH_PROGRESS="BATCH_PROGRESS"}(e||(e={}));const t=document.getElementById("settings-form"),n=document.getElementById("api-url"),a=document.getElementById("api-key"),s=document.getElementById("vault-name"),c=document.getElementById("folder-path"),i=document.getElementById("enabled"),l=document.getElementById("use-webhook"),o=document.getElementById("webhook-url"),r=document.getElementById("webhook-field"),d=document.getElementById("default-tags"),u=document.getElementById("default-author"),m=document.getElementById("include-description"),h=document.getElementById("include-publish-date"),y=document.getElementById("save-button"),f=document.getElementById("test-button"),E=document.getElementById("status"),v=document.getElementById("clear-cache");function I(e,t){E.textContent=e,E.className=`status ${t}`,E.style.display="block",setTimeout(()=>{E.style.display="none"},5e3)}async function g(e){return new Promise(t=>{chrome.runtime.sendMessage(e,e=>{t(e)})})}l.addEventListener("change",()=>{r.style.display=l.checked?"block":"none"}),document.addEventListener("DOMContentLoaded",async function(){try{const t=await g({type:e.GET_SETTINGS});if(t.success&&t.data){const e=t.data;n.value=e.apiUrl,a.value=e.apiKey,s.value=e.vaultName,c.value=e.folderPath,i.checked=e.enabled,l.checked=e.useWebhook||!1,o.value=e.webhookUrl||"",d.value=(e.defaultTags||["clippings"]).join(", "),u.value=e.defaultAuthor||"",m.checked=!1!==e.includeDescription,h.checked=!1!==e.includePublishDate,r.style.display=e.useWebhook?"block":"none"}}catch(e){I("Failed to load settings","error")}}),t.addEventListener("submit",async function(t){t.preventDefault();const r=n.value.trim().replace(/\/$/,""),f=d.value.split(",").map(e=>e.trim()).filter(e=>e.length>0),E={apiUrl:r,apiKey:a.value.trim(),vaultName:s.value.trim(),folderPath:c.value.trim(),enabled:i.checked,useWebhook:l.checked,webhookUrl:o.value.trim(),defaultTags:f.length>0?f:["clippings"],defaultAuthor:u.value.trim()||void 0,includeDescription:m.checked,includePublishDate:h.checked};if(E.apiUrl)if(E.apiKey)if(E.vaultName)try{y.disabled=!0,y.textContent="Saving...";const t=await g({type:e.SAVE_SETTINGS,data:E});t.success?I("Settings saved successfully!","success"):I(`Failed to save: ${t.error}`,"error")}catch(e){I("Failed to save settings","error")}finally{y.disabled=!1,y.textContent="Save Settings"}else I("Vault name is required","error");else I("API Key is required","error");else I("API URL is required","error")}),f.addEventListener("click",async function(){const e=n.value.trim().replace(/\/$/,""),t=a.value.trim();if(s.value.trim(),e&&t)try{f.disabled=!0,f.textContent="Testing...",I("Testing API connection...","success");const n=await fetch(`${e}/`,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok&&404!==n.status)return void I(`✗ Cannot reach API: ${n.status} - Check if Obsidian is running and Local REST API plugin is enabled`,"error");I("✓ API reachable! Testing vault access...","success");const a=await fetch(`${e}/active/`,{headers:{Authorization:`Bearer ${t}`}});if(a.ok)return void I("✓ Connection successful! API key is valid.","success");const s=await fetch(`${e}/periodic/`,{headers:{Authorization:`Bearer ${t}`}});if(s.ok||404===s.status)return void I("✓ Connection successful! API key is valid.","success");I(`✗ API key may be invalid: ${a.status}`,"error")}catch(t){t instanceof TypeError&&t.message.includes("fetch")?I(`✗ Cannot reach ${e} - Is Obsidian running? Is Local REST API plugin enabled?`,"error"):I(`✗ Connection failed: ${t instanceof Error?t.message:"Unknown error"}`,"error")}finally{f.disabled=!1,f.textContent="Test Connection"}else I("Please fill in API URL and API Key first","error")}),v.addEventListener("click",async function(){if(confirm("Are you sure you want to clear the cache of clipped URLs? This will remove all duplicate detection history."))try{await chrome.storage.local.set({clippedUrls:[]}),I("Cache cleared successfully!","success")}catch(e){I("Failed to clear cache","error")}})})();